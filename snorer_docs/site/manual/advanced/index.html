<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Advanced Topics - snorer</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet" />
        <link href="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/output/chtml/fonts/woff-v2.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Advanced Topics";
        var mkdocs_page_input_path = "manual/advanced.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> snorer
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Introduction</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">User Manual</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" >Overview</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../overview/">BDM Physics</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tutorial/">Tutorial</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Advanced Topics</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#distribution-across-the-celestial-sphere">Distribution across the celestial sphere</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#user-defined-scattering-amplitude">User-defined scattering amplitude</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../demo/">Demonstration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API References</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/params/params/">Parameters</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Main</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" >Functions</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../api/main/sn_nu_spectrum/">sn_nu_spectrum</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../api/main/dsigma_xv/">dsigma_xv</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../api/main/emissivity_jx/">emissivity_jx</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../api/main/differential_flux/">differential_flux</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../api/main/flux/">flux</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../api/main/event/">event</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Halo</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" >Classes</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../api/halo/HaloSpike/">HaloSpike</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Functions</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../api/halo/M_sigma/">M_sigma</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../api/halo/nx/">nx</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../api/halo/nxSpike/">nxSpike</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../api/halo/radiusInfluence/">radiusInfluence</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../api/halo/radiusSchwarzschild/">radiusSchwarzschild</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../api/halo/rhox/">rhox</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Kinematics</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../api/kinematics/22scat/">2-2 elastic scattering</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Classes</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../api/kinematics/Kinematics/">Kinematics</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../api/kinematics/Mandelstam/">Mandelstam</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../api/kinematics/Neutrino/">Neutrino</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Functions</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../api/kinematics/get_gx/">get_gx</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../api/kinematics/get_thetaMax/">get_thetaMax</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../api/kinematics/get_tvan/">get_tvan</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../api/kinematics/get_psiMax/">get_psiMax</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../api/kinematics/get_vx/">get_vx</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../api/kinematics/KallenLambda/">KallenLambda</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Propagation</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../api/geometry/Positioning/">Positioning</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Classes</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../api/geometry/Geometry/">Geometry</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../api/geometry/Propagation/">Propagation</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Utilities</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../api/utils/coord_transf/">Coordinate Transformations</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Classes</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../api/utils/BDM/">BoostedDarkMatter</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Functions</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../api/utils/gal_to_beta/">galactic_to_beta</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../api/utils/equa_to_beta/">equatorial_to_beta</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/constants/Constants/">Constants</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">snorer</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">User Manual</li>
      <li class="breadcrumb-item active">Advanced Topics</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <script>
window.MathJax = {
  tex: {
    tags: "ams"  // Auto-numbering, AMS based
  }
};
</script>

<style>
.mono {
    font-family: monospace;
}
</style>

<h1 id="advanced-topics">Advanced Topics<a class="headerlink" href="#advanced-topics" title="Permanent link">&para;</a></h1>
<p>We introduce some advanced usage in this document. In the following content, all equation numbers refer to <a href="../overview/#snnu-spectrum" target="_blank">BDM Physics</a> unless specified otherwise. First, import the necessary packages:</p>
<pre><code class="language-python"># import python packages
import numpy as np
import ipyparallel as ipp

# import plotting package
import matplotlib.pyplot as plt
import matplotlib.colors as mcolors
# uncomment the following two lines if you have a Hi-DPI monitor and wish to have a better figure resolution
# %matplotlib inline
# %config InlineBackend.figure_format='retina'

# import snorer
import snorer as sn
print(f'Current version of snorer: {sn.__version__}')
</code></pre>
<pre><code class="language-shell">Current version of snorer: 2.0.0
</code></pre>
<h2 id="distribution-across-the-celestial-sphere">Distribution across the celestial sphere<a class="headerlink" href="#distribution-across-the-celestial-sphere" title="Permanent link">&para;</a></h2>
<p>We draw how supernova-neutrino-boosted dark matter (SN<span class="arithmatex">\(\nu\)</span> BDM) distributes across the sky. </p>
<p>We use <a href="http://snrcat.physics.umanitoba.ca/SNRrecord.php?id=G111.7m02.1" target="_blank">Cassiopeia A</a> (Cas A) to be our SN in this example. Its <span class="arithmatex">\(\alpha\)</span> and <span class="arithmatex">\(\delta\)</span> are 23h23m24s and 58d49m00s respectively and <span class="arithmatex">\(R_s\approx 3.5\)</span> kpc.
Hence, we obtain the off-center angle <span class="arithmatex">\(\beta\)</span> and its galactic coordinate by</p>
<pre><code class="language-python">casA_beta,l_sn,b_sn = sn.equatorial_to_beta('23h23m24s','58d49m00s')
print(f&quot;The off-center angle for Cas A approximates {casA_beta:.3f} rad.&quot;)
</code></pre>
<pre><code class="language-shell">The off-center angle for Cas A approximates 1.950 rad.
</code></pre>
<p>To evaluate the distribution across the sky, it is equivalent to draw</p>
<div class="arithmatex">\[
\begin{equation}
\left.\frac{d\Phi_\chi}{dT_\chi d\Omega} = \tau_s \mathcal{J} j_\chi\right|_{t=\frac{d}{c}+\frac{\ell}{v_\chi}-t_\nu}
\end{equation}
\]</div>
<p>on the celestial sphere spanned by the galactic coordinate <span class="arithmatex">\(\ell\)</span> and <span class="arithmatex">\(b\)</span>.</p>
<p>The corresponding function in <strong>snorer</strong> is <a href="../../api/main/differential_flux/" target="_blank"><code>sn.differential_flux</code></a> with 10 parameters. The first seven <code>t</code>, <code>Tx</code>, <code>mx</code>, <code>theta</code>, <code>phi</code>, <code>Rs</code>, <code>beta</code> are mandatory and the last three <code>Re = 8.5</code>, <code>sigxv0 = 1e-45</code> and <code>is_spike = False</code> are optional. Note that <code>theta</code> and <code>phi</code> are the zenith and azimuthal angles, cf. <a href="../overview/#snv_bdm_scheme" target="_blank">Fig. 1</a> in BDM Physics.</p>
<figure>
<center><img src="../../figs/gal_sn.svg" alt="scheme" style="width: 60%;">
<figcaption>Figure 1. Cas A and its location \((\ell_s,b_s)\) on the galactic coordinate. Another point \((\ell_0,b_0)\) is also labeled.
</figure>

<p>Suppose Cas A locates at <span class="arithmatex">\((\ell_s,b_s)\)</span> on the galactic coordinate shown in Fig. 1, another point <span class="arithmatex">\((\ell_0,b_0)\)</span> that is distant from Cas A by <span class="arithmatex">\(\theta\)</span> and rotates by <span class="arithmatex">\(\varphi\)</span> azimuthally. We can determined them through</p>
<div class="arithmatex">\[
\begin{equation}
\theta = \sqrt{\ell^{\prime 2}+b^{\prime 2}},\quad {\rm and} \quad \varphi= \tan^{-1}\left(\frac{\ell^\prime}{b^\prime}\right)
\end{equation}
\]</div>
<p>where</p>
<div class="arithmatex">\[
\begin{equation}
\ell^\prime = \ell_0 - \ell_s\quad{\rm and}\quad b^\prime = b_0-b_s.
\end{equation}
\]</div>
<p>With <span class="arithmatex">\(\theta\)</span> and <span class="arithmatex">\(\varphi\)</span>, we further apply both to <code>sn.differential_flux</code> to get the differential flux.</p>
<p>Note that we will eventually display the result using the Aitoff projection and in <strong>matplotlib</strong> such projections <span class="arithmatex">\(\ell\in[-\pi,\pi)\)</span>, thus we define a function <code>wrap_angle</code> to convert <span class="arithmatex">\(\ell\)</span> from <span class="arithmatex">\([0,2\pi)\)</span> to <span class="arithmatex">\([-\pi,\pi)\)</span>.
The step-by-step approach is to:</p>
<ol>
<li>Construct a canvas across the entire galactic coordinate</li>
<li>Calculate the <span class="arithmatex">\((\theta,\varphi)\)</span> for every point <span class="arithmatex">\((\ell,b)\)</span> on the canvas</li>
<li>Put <span class="arithmatex">\((\theta,\varphi)\)</span> into <code>sn.differential_flux</code> and retrieve the BDM differential flux at that point</li>
</ol>
<pre><code class="language-python">def wrap_angle(l):
    &quot;&quot;&quot;Confine longitudinal in -pi and pi&quot;&quot;&quot;
    return (l + np.pi) % (2 * np.pi) - np.pi

# Setup DM properties
Tx,mx = 5,1
Rs = 3.5 # kpc
t = 350 * sn.constant.year2Seconds

# Setup canvas for galactic coordinate l and b
l_vals = np.linspace(-np.pi,np.pi,800)
b_vals = np.linspace(-np.pi/2,np.pi/2,400)
L,B = np.meshgrid(l_vals,b_vals,indexing=&quot;ij&quot;)

# Evaluate dtheta and dvarphi for each grid point on the canvas
L_coord = wrap_angle(L - l_sn) # adjust galactic longitude to [-pi, pi) 
B_coord = B - b_sn
dtheta = np.sqrt(L_coord**2 + B_coord**2)
dphi = np.arctan2(L_coord,B_coord)%(2 * np.pi) # using atan2 and mod 2pi to convert galactic latitude to [-pi/2, pi/2)

# Canvas to store the result
diffFlux = np.zeros_like(L)

with np.nditer([dtheta,dphi,diffFlux],op_flags=[['readonly'],['readonly'],['writeonly']]) as it:
    for theta,phi,flux in it:
        flux[...] = sn.differential_flux(t,Tx,mx,theta,phi,Rs,casA_beta)

# Plot
fig = plt.figure(figsize=(12, 5))
ax = fig.add_subplot(111,projection='aitoff')
norm = mcolors.SymLogNorm(linthresh=diffFlux.max()/1e2, vmin=diffFlux.max()/5e1, vmax=diffFlux.max(), base=10)
mesh = ax.pcolormesh(L , B, diffFlux, cmap='inferno', norm=norm, rasterized=True)

cbar = fig.colorbar(mesh, ax=ax, orientation='vertical')
cbar.set_label(r&quot;$d\Phi_\chi/dtd\Omega$ [MeV$^{-1}$ cm$^{-2}$ s$^{-1}$ sr$^{-1}$]&quot;)

# axis label style
ax.tick_params(axis=&quot;x&quot;, colors=&quot;white&quot;)
ax.grid(True,linestyle='--', linewidth=0.7)

# axis ticks
x_ticks = np.linspace(-np.pi + np.pi/6, np.pi - np.pi/6, 11)
y_ticks = np.linspace(-np.pi/2, np.pi/2, 13)

ax.set_xticks(x_ticks)  # set galactic longitude tick labels
ax.set_xticklabels([r'−150°', '−120°', '−90°', '−60°', '−30°', '0°', '30°', '60°', '90°', '120°', '150°'])
ax.set_yticks(y_ticks)  # set galactic latitude tick labels
ax.set_yticklabels(['−90°', '−75°', '−60°', '−45°', '−30°', '−15°', '0°', '15°', '30°', '45°', '60°', '75°', '90°'])

ax.set_title(r'Cas A: $(T_\chi,m_\chi)=(5,1)$ MeV',y=1.1)
plt.show()
</code></pre>
<figure>
<center><img src="../../figs/output_7_0.png" alt="scheme" style="width: 90%;">
</figure>

<p>Note the above is a particular slice of <span class="arithmatex">\(T_\chi\)</span>. For practical case, one should integrate <code>sn.differential_flux</code> over a range of <span class="arithmatex">\(T_\chi\)</span> due to none of the existing detectors having infinite energy resolution.</p>
<h2 id="user-defined-scattering-amplitude">User-defined scattering amplitude<a class="headerlink" href="#user-defined-scattering-amplitude" title="Permanent link">&para;</a></h2>
<p>Functions <code>sn.flux</code> and <code>sn.event</code> and the core functions to construct them are all based on energy-independent cross sections <span class="arithmatex">\(\sigma_{\chi\nu}\)</span> and <span class="arithmatex">\(\sigma_{\chi e}\)</span>.
However, by introducing a specific particle model, cross sections are no longer energy-independent but depend on the Mandelstam variables and model parameters.
Thus, <code>sn.flux</code> and <code>sn.event</code> are not applicable.</p>
<p>To resolve this issue, we provide a class <a href="../../api/utils/BDM/" target="_blank"><code>sn.BoostedDarkMatter</code></a> to cope with.
This class integrate all the functions to evaluate BDM flux and event and manipulating halo properties as class <em>methods</em>.
Additionally, this class takes scattering amplitudes for <span class="arithmatex">\(\chi\nu\)</span> and <span class="arithmatex">\(\chi e\)</span> interactions as its parameters and calculate <span class="arithmatex">\(d\sigma_{\chi\nu}/d\Omega_{\rm lab}\)</span> and <span class="arithmatex">\(\sigma_{\chi e}\)</span> automatically. We illustrate this by the famous <span class="arithmatex">\(L_{\mu-\tau}\)</span> model with DM component <span class="arithmatex">\(\chi\)</span>.
The Lagrangian is</p>
<div class="arithmatex">\[
\begin{alignat}{1}
    \mathcal{L}_\chi  \supset &amp; -\frac{1}{4}V_{\mu\nu}V^{\mu\nu}+\frac{\varepsilon}{2\cos\theta_W}F_{\mu\nu}V^{\mu\nu}-\frac{1}{2}m_V^2 V_\mu V^\mu \nonumber \\
    &amp; \quad -m_\chi \bar{\chi}\chi +g_\chi V_\mu \bar{\chi}\gamma^\mu \chi \nonumber \\
    &amp; \quad +g_V V_\mu Q_{\alpha\beta}\left(\bar{\ell}_\alpha\gamma^\mu \ell_\beta +\bar{\nu}_\alpha \gamma^\mu P_L \nu_\beta\right)
\end{alignat}
\]</div>
<p>with the first line for kinetic mixing, the second line for dark sector interaction and the last for coupling between dark and lepton sector.
The associated Feynman diagrams for <span class="arithmatex">\(\chi \nu\)</span> and <span class="arithmatex">\(\chi e\)</span> scatterings are shown in Fig. 2.</p>
<figure>
<center><img src="../../figs/feynman_chi-nu.svg" alt="scheme" style="width: 30%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    <img src="../../figs/feynman_chi-e.svg" alt="scheme" style="width: 30%;">
<figcaption>Figure 2. Feynman diagrams for \(\chi\nu\) (left) and \(\chi e\) (right) scatterings described by \(L_{\mu-\tau}\) model.
</figure>

<p>The amplitude squared <span class="arithmatex">\(|\mathcal{M}|^2\)</span> is given by</p>
<div class="arithmatex">\[
\begin{equation}
|\mathcal{M}|^{2} =2\left(\frac{\mathcal{Q}}{t-m_{V}^{2}}\right)^{2}[s^{2}+u^{2}
  +4t(m_{1}^{2}+m_{2}^{2}) -2(m_{1}^{2}+m_{2}^{2})^{2}],
\end{equation}
\]</div>
<p>where <span class="arithmatex">\(s\)</span>, <span class="arithmatex">\(t\)</span> and <span class="arithmatex">\(u\)</span> are Mandelstam variables and <span class="arithmatex">\(m_1\)</span> and <span class="arithmatex">\(m_2\)</span> are incoming and being scattered particles respectively. We can encode such information into python function by</p>
<pre><code class="language-python">def amp2_xv(s,t,u,mx) -&gt; float:
    &quot;&quot;&quot;DM-v scattering amplitude squared&quot;&quot;&quot;
    mV = mx/3
    gV,gx = 1e-06,1e-02
    Q = gV*gx
    return (s**2 + u**2 + 4*t*(mx**2) - 2*(mx**2)**2)*(Q/(t - mV**2))**2

def amp2_xe(s,t,u,mx) -&gt; float:
    &quot;&quot;&quot;DM-e scattering amplitude squared&quot;&quot;&quot;
    mV = mx/3
    me = 0.511 # MeV
    gx,eps = 1e-02,1e-06
    Q = gx*eps
    return 2*(s**2 + u**2 + 4*t*(me**2 + mx**2) - 2*(me**2 + mx**2)**2)*(Q/(t - mV**2))**2
</code></pre>
<p>Both functions <em>only</em> take <strong><em>4 positioning arguments</em></strong> with the first three are Mandelstam variables (MeV<sup>2</sup>) and the last is DM mass (MeV). Other model parameters should be defined either in the function or somewhere else. They cannot be the function input(s).</p>
<p>We again use Cas A as the example. First, build up the instance for Cas A BDM and given it is within our Milky Way, we have <span class="arithmatex">\(R_g = R_e=8.5\)</span> kpc.</p>
<pre><code class="language-python">casA_bdm = sn.BoostedDarkMatter(Rs=Rs,Rg=8.5,beta=casA_beta,amp2_xv=amp2_xv,amp2_xe=amp2_xe,is_spike=False)
</code></pre>
<p>There are plenty of methods can be called in the instance <code>casA_bdm</code>. For example, we can examine the associated <span class="arithmatex">\(d\sigma_{\chi\nu}/d\Omega_{\rm lab}\)</span> and <span class="arithmatex">\(\sigma_{\chi e}\)</span>:</p>
<pre><code class="language-python"># Differential DM-v cross sections
Tx,mx = 5,1
# Get maximumlly allowed psi
psi_max = sn.get_psiMax(Tx,mx)
psi_max -= psi_max/1000 # avoid diverge at psi_max
psi_vals = np.linspace(0,psi_max,100)
# differential sigma_xv
dsigxv = [casA_bdm.dsigma_xv(Tx,mx,psi) for psi in psi_vals]

# Plot
plt.plot(psi_vals,dsigxv)
plt.yscale('log')
plt.xlabel(r'$\psi$ [rad]')
plt.ylabel(r'$d\sigma_{\chi\nu}/d\Omega_{\rm lab}$ [cm$^2$ sr$^{-1}$]')
plt.show()
</code></pre>
<figure>
<center><img src="../../figs/output_15_0.png" alt="scheme" style="width: 60%;">
</figure>

<pre><code class="language-python"># Differential DM-e cross sections
mx = 1
Tx_vals = np.logspace(-5,2,100)
# differential sigma_xv
sigxe = [casA_bdm.sigma_xe(Tx,mx) for Tx in Tx_vals]

# Plot
plt.plot(Tx_vals,sigxe)
plt.xscale('log')
plt.yscale('log')
plt.xlabel(r'$T_\chi$ [MeV]')
plt.ylabel(r'$\sigma_{\chi e}$ [cm$^2$]')
plt.show()
</code></pre>
<figure>
<center><img src="../../figs/output_16_0.png" alt="scheme" style="width: 60%;">
</figure>

<p>Now we are ready to evaluate the BDM flux and event. For flux, given Cas A exploded 350 years ago, it is already 350 year-old. We have to determine the vanishing time first.</p>
<pre><code class="language-python"># Setup DM properties
Tx,mx = 5,1
Rs = 3.5 # kpc
tvan = sn.get_tvan(Tx,mx,Rs)
print(f'Vanishing time is {tvan/sn.constant.year2Seconds:.2f} years.')
</code></pre>
<pre><code class="language-shell">Vanishing time is 557.07 years.
</code></pre>
<p>Hence for <span class="arithmatex">\((T_\chi,m_\chi)=(5,1)\)</span> MeV, <span class="arithmatex">\(t_{\rm van}=557.07\)</span> years. However, 350 years have passed, leaving only 207 years atmost before it ceases completely. We can use the <code>flux</code> method to evaluate. It takes 3 inputs: <code>t</code>, <code>Tx</code> and <code>mx</code>. Additional <code>**kwargs</code> determine the cut distances <code>d_cut</code> and <code>r_cut</code> for SN<span class="arithmatex">\(\nu\)</span> spectrum and halo profile, respectively, due to both are proportional <span class="arithmatex">\(1/L^n\)</span> and diverges when <span class="arithmatex">\(L\to 0\)</span>.
Others like <code>nitn</code> and <code>neval</code> are for <strong>vegas</strong>. Note that this method does not contain any <code>**kwargs</code> related to halo profile as the halo behavior is decided  during the initialization of the instance.
See their API pages: <a href="../../api/utils/BDM/" target="_blank"><code>sn.BoostedDarkMatter</code></a> and <a href="../../api/params/params/" target="_blank"><code>sn.params</code></a> for detail.</p>
<pre><code class="language-python">t0 = 350 * sn.constant.year2Seconds
time_vals = np.linspace(t0,tvan,70)

def get_casA_flux(t,Rs=Rs,Rg=8.5,beta=casA_beta,amp2_xv=amp2_xv,amp2_xe=amp2_xe):
    &quot;&quot;&quot;flux&quot;&quot;&quot;
    import snorer as sn
    Tx,mx = 5,1
    casA_bdm = sn.BoostedDarkMatter(Rs=Rs,Rg=8.5,beta=beta,amp2_xv=amp2_xv,amp2_xe=amp2_xe,is_spike=False)
    return casA_bdm.flux(t,Tx,mx,neval=5000)

# request a cluster
with ipp.Cluster(n = 5) as rc: # 5 cores
    # get a view on the cluster
    view = rc.load_balanced_view()
    # submit the tasks
    asyncresult = view.map_async(get_casA_flux, time_vals)
    # wait interactively for results
    asyncresult.wait_interactive()
    # retrieve actual results
    casA_flux = asyncresult.get()
</code></pre>
<pre><code class="language-shell">Starting 5 engines with &lt;class 'ipyparallel.cluster.launcher.LocalEngineSetLauncher'&gt;
    0%|          | 0/5 [00:00&lt;?, ?engine/s]
get_casA_flux:   0%|          | 0/70 [00:00&lt;?, ?tasks/s]
Stopping engine(s): 1742019912
engine set stopped 1742019912: {'engines': {'0': {'exit_code': 0, 'pid': 35213, 'identifier': '0'}, '1': {'exit_code': 0, 'pid': 35214, 'identifier': '1'}, '2': {'exit_code': 0, 'pid': 35215, 'identifier': '2'}, '3': {'exit_code': 0, 'pid': 35216, 'identifier': '3'}, '4': {'exit_code': 0, 'pid': 35217, 'identifier': '4'}}, 'exit_code': 0}
Stopping controller
Controller stopped: {'exit_code': 0, 'pid': 35201, 'identifier': 'ipcontroller-1742019911-edc4-31540'}
</code></pre>
<pre><code class="language-python">plt.plot(time_vals/sn.constant.year2Seconds + 1675,casA_flux)
plt.yscale('log')
plt.ylim(3e-16,)
plt.xlabel(r'Anno Domini')
plt.ylabel(r'$d\Phi_\chi/dT_\chi dt$ [MeV$^{-1}$ cm$^{-2}$ s$^{-1}$]')
plt.show()
</code></pre>
<figure>
<center><img src="../../figs/output_21_0.png" alt="scheme" style="width: 60%;">
</figure>

<p>To evaluate event number, remember the parameter <code>t_range</code> in <code>sn.event</code> is the integration range of time interval and starts from <span class="arithmatex">\(t_0=10\)</span> seconds by default.
But it is not the case for Cas A as 350 years has passed. We shoud begin <span class="arithmatex">\(t_0=350\)</span> years and end with, say, 35 years after <span class="arithmatex">\(t_0\)</span>. Hence,</p>
<pre><code class="language-python">mx_vals = np.logspace(-6,2,35)

def get_casA_event(mx,Rs=Rs,Rg=8.5,beta=casA_beta,amp2_xv=amp2_xv,amp2_xe=amp2_xe):
    &quot;&quot;&quot;flux&quot;&quot;&quot;
    import snorer as sn
    t0 = 350 * sn.constant.year2Seconds
    tf = (350 + 35) * sn.constant.year2Seconds
    casA_bdm = sn.BoostedDarkMatter(Rs=Rs,Rg=8.5,beta=beta,amp2_xv=amp2_xv,amp2_xe=amp2_xe,is_spike=False)
    try:
        event = casA_bdm.event(mx,t_range=[t0,tf],neval=15000)
    except:
        event = 0
    return event

# request a cluster
with ipp.Cluster(n = 5) as rc: # 5 cores
    # get a view on the cluster
    view = rc.load_balanced_view()
    # submit the tasks
    asyncresult = view.map_async(get_casA_event, mx_vals)
    # wait interactively for results
    asyncresult.wait_interactive()
    # retrieve actual results
    casA_event = asyncresult.get()
</code></pre>
<pre><code class="language-shell">Starting 5 engines with &lt;class 'ipyparallel.cluster.launcher.LocalEngineSetLauncher'&gt;
    0%|          | 0/5 [00:00&lt;?, ?engine/s]
get_casA_event:   0%|          | 0/35 [00:00&lt;?, ?tasks/s]
engine set stopped 1742023011: {'engines': {'1': {'exit_code': 0, 'pid': 36515, 'identifier': '1'}, '2': {'exit_code': 0, 'pid': 36516, 'identifier': '2'}, '0': {'exit_code': 0, 'pid': 36514, 'identifier': '0'}, '3': {'exit_code': 0, 'pid': 36517, 'identifier': '3'}, '4': {'exit_code': 0, 'pid': 36518, 'identifier': '4'}}, 'exit_code': 0}
Stopping engine(s): 1742023069
engine set stopped 1742023069: {'engines': {'0': {'exit_code': 0, 'pid': 36594, 'identifier': '0'}, '1': {'exit_code': 0, 'pid': 36595, 'identifier': '1'}, '2': {'exit_code': 0, 'pid': 36596, 'identifier': '2'}, '3': {'exit_code': 0, 'pid': 36597, 'identifier': '3'}, '4': {'exit_code': 0, 'pid': 36598, 'identifier': '4'}}, 'exit_code': 0}
Stopping controller
Controller stopped: {'exit_code': 0, 'pid': 36580, 'identifier': 'ipcontroller-1742023068-i421-31540'}
</code></pre>
<pre><code class="language-python">plt.scatter(mx_vals,casA_event)
plt.xscale('log')
plt.yscale('log')
#plt.ylim(3e-16,)
plt.xlabel(r'$m_\chi$ [MeV]')
plt.ylabel(r'$N_\chi$ per electron')
plt.show()
</code></pre>
<figure>
<center><img src="../../figs/output_24_0.png" alt="scheme" style="width: 60%;">
</figure>

<p>Unlike <code>sn.event</code> which the result is normalized to per electron and <span class="arithmatex">\(\sigma_{\chi e}=1\)</span> cm<sup>2</sup>, in this class instance, <span class="arithmatex">\(\sigma_{\chi e}\)</span> is determined by user-specified <span class="arithmatex">\(|\mathcal{M}|^2\)</span>, thus the cross section is exact what user expects at such energy.
One only needs to multiply the correct electron number <span class="arithmatex">\(N_e\)</span> in that detector. For example, Super-K has <span class="arithmatex">\(7\times 10^{33}\)</span> electrons approximately, then the BDM event is</p>
<div class="arithmatex">\[
N_\chi^{\rm SK} = N_e^{\rm SK} \times N_\chi = 7\times 10^{33} N_\chi
\]</div>
<p>In the above plot, one sees that no event when <span class="arithmatex">\(m_\chi\lesssim 500\)</span> keV. It is because the corresponding <span class="arithmatex">\(t_{\rm van}\)</span> for <span class="arithmatex">\(m_\chi\)</span> and <span class="arithmatex">\(T_\chi\)</span>-integrated range are much smaller than 350 years.
Thus BDM from Cas A no longer exists at the present day.</p>
<h3 id="dm-nucleus-scattering">DM-nucleus scattering<a class="headerlink" href="#dm-nucleus-scattering" title="Permanent link">&para;</a></h3>
<p>We discuss a more general case when target in the detector is not electron. Though by default <code>sn.BoostedDarkMatter</code> assumes <span class="arithmatex">\(\chi e\)</span> scattering, but the parameter <code>amp2_xe</code> is not exclusively for <span class="arithmatex">\(\chi e\)</span> interaction. </p>
<p>To elaborate, we assume the target to be interacted is Xenon with target mass approximating <span class="arithmatex">\(m_t = 1.3\times 10^5\)</span> MeV. We can rewrite <code>amp2_xe</code> by</p>
<pre><code class="language-python">m_xenon = 1.3e5 # xenon mass

def amp2_x_xenon(s,t,u,mx) -&gt; float:
    &quot;&quot;&quot;DM-xenon scattering amplitude squared&quot;&quot;&quot;
    mV = mx/3
    mt = m_xenon # xenon mass, MeV
    gx,eps = 1e-02,1e-06
    Q = gx*eps
    return 2*(s**2 + u**2 + 4*t*(mt**2 + mx**2) - 2*(mt**2 + mx**2)**2)*(Q/(t - mV**2))**2
</code></pre>
<p>When initialize <code>sn.BoostedDarkMatter</code> instance, we have to specify the target mass <code>mt</code> too, such as</p>
<pre><code class="language-python">casA_bdm_xenon = sn.BoostedDarkMatter(Rs=Rs,Rg=8.5,beta=casA_beta,amp2_xv=amp2_xv,amp2_xe=amp2_x_xenon,mt=m_xenon,is_spike=False)
</code></pre>
<p>Now we compare the associated <span class="arithmatex">\(\sigma_{\chi e}\)</span> and <span class="arithmatex">\(\sigma_{\chi-{\rm Xe}}\)</span>,</p>
<pre><code class="language-python"># Differential DM-e cross sections
mx = 1
Tx_vals = np.logspace(-5,2,100)
sigxe = [casA_bdm.sigma_xe(Tx,mx) for Tx in Tx_vals]
sigx_xe = [casA_bdm_xenon.sigma_xe(Tx,mx) for Tx in Tx_vals]

# Plot
plt.plot(Tx_vals,sigx_xe,label=r'$\sigma_{\chi - {\rm Xe}}$')
plt.plot(Tx_vals,sigxe,label=r'$\sigma_{\chi e}$')
plt.xscale('log')
plt.yscale('log')
plt.xlabel(r'$T_\chi$ [MeV]')
plt.ylabel(r'$\sigma$ [cm$^2$]')
plt.legend()
plt.show()
</code></pre>
<figure>
<center><img src="../../figs/output_31_0.png" alt="scheme" style="width: 60%;">
</figure>

<p>Thus in <code>casA_bdm_xenon</code>, the method <code>sigma_xe</code> is for DM-Xenon interaction cross section. Note that the above is a very naive example and is not plausible in practice. Given when nucleus is under discussion, nucleus form factor should be introduced in <code>amp2_x_xenon</code>. We relegate this to the users who work in this field. </p>
<h3 id="override-methods-dsigma_xv-and-sigma_xe">Override methods <code>dsigma_xv</code> and <code>sigma_xe</code><a class="headerlink" href="#override-methods-dsigma_xv-and-sigma_xe" title="Permanent link">&para;</a></h3>
<p>Under certain circumstances, issues and unstable results may occur in our algorithm for calculating <code>dsigma_xv</code> and <code>sigma_xe</code>. 
If this happens, users may wish to override these two methods with their own functions.
It can be done easily, given that <code>dsigma_xv</code> and <code>sigma_xe</code> take <strong><em>three</em></strong> and <strong><em>two</em></strong> <em>positioning arguments</em>, respectively. See this <a href="../../api/utils/BDM/" target="_blank">API page</a>. Users can provide their own functions and replace them, as long as the units for <code>dsigma_xv</code> and <code>sigma_xe</code> are cm<sup>2</sup> sr<sup>−1</sup> and cm<sup>2</sup>, respectively.</p>
<p>For example, let <code>dsigma_xv</code> and <code>sigma_xe</code> be constant </p>
<pre><code class="language-python"># constant dsigma_xv
casA_bdm.dsigma_xv = lambda Tx,mx,psi: 1e-35/4/np.pi
# constant sigma_xe
casA_bdm.sigma_xe = lambda Tx,mx: 1e-35
</code></pre>
<p>This will override the methods for calculating cross sections in <code>casA_bdm</code> and affect <code>casA_bdm.flux</code> and <code>casA_bdm.event</code>.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../tutorial/" class="btn btn-neutral float-left" title="Tutorial"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../demo/" class="btn btn-neutral float-right" title="Demonstration">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../tutorial/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../demo/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/js/all.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
